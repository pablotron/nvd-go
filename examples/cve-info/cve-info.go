//go:build exclude
//
// cve-info.go: Get information about CVE from NVD API.
//
// Example:
//
// ```
// $ export NVD_API_KEY='xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx'
// $ go run examples/cve-info/cve-info.go CVE-2023-1233
// CVE ID: CVE-2023-1233
// Description: Insufficient policy enforcement in Resource Timing in ...
// CVSS Vector: CVSS:3.1/AV:N/AC:L/PR:N/UI:R/S:U/C:L/I:N/A:N
// CVSS Base Score: 4.3
// CVSS Base Severity: MEDIUM
// ```
package main

import (
  "fmt"
  "log"
  "os"
  "pmdn.org/nvd-go/cve"
  "pmdn.org/nvd-go/nvd-api"
)

// Get application name from command-line arguments, or return
// "cve-info" otherwise.
func appName() string {
  if len(os.Args) > 0 {
    return os.Args[0]
  } else {
    return "cve-search"
  }
}

// summary format string
var formatStr = `CVE ID: %s
Description: %s
CVSS Vector: %s
CVSS Base Score: %s
CVSS Base Severity: %s
`

// Summarize vulnerability.
func summarize(v nvd_api.Vulnerability) string {
  // get CVE ID
  cveId := v.Cve.Id.String()

  // get description string
  description := "n/a"
  if len(v.Cve.Descriptions) > 0 {
    description = v.Cve.Descriptions[0].Value
  }

  // get vector string, base score, and base severity
  vector := "n/a"
  baseScore := "n/a"
  baseSeverity := "n/a"
  if len(v.Cve.Metrics.CvssMetricV31) > 0 {
    // get CVSS data for first CVSS v3.1 metric
    data := v.Cve.Metrics.CvssMetricV31[0].CvssData

    vector = data.Vector.String()
    baseScore = data.BaseScore.String()
    baseSeverity = data.BaseSeverity.String()
  }

  // return summary string
  return fmt.Sprintf(formatStr, cveId, description, vector, baseScore, baseSeverity)
}

func main() {
  // get api key from environment variable
  apiKey := os.Getenv("NVD_API_KEY")
  if apiKey == "" {
    log.Fatal("Missing environment variable: NVD_API_KEY")
  }

  // check argument count
  if len(os.Args) < 2 {
    log.Fatalf("Usage: %s <CVE ID>", appName())
  }

  // Parse first argument as CVE ID
  cveId, err := cve.ParseId(os.Args[1])
  if err != nil {
    log.Fatal(fmt.Errorf("ParseId(): %w", err))
  }

  // create NVD API client
  client := nvd_api.NewClient(apiKey)

  // search cves
  r, err := client.Cves(nvd_api.CveParams { CveId: cveId })
  if err != nil {
    log.Fatal(fmt.Errorf("Cves(): %w", err))
  }

  // check result count
  if len(r.Vulnerabilities) < 1 {
    log.Fatal("Unknown CVE ID: %s", cveId)
  }

  // print summary of first vulnerability
  fmt.Print(summarize(r.Vulnerabilities[0]))
}
