package nvd_api

import (
  "encoding/json"
  "pmdn.org/nvd-go/rfc3339"
  "reflect"
  "testing"
)

func TestVulnerabilityUnmarshalJSON(t *testing.T) {
  // read cve data
  data := readTestData(t, "testdata/cve-2022-44006.json.gz")

  // unmarshal vulnerability
  var v Vulnerability
  if err := json.Unmarshal(data, &v); err != nil {
    t.Fatal(err)
  }

  t.Run("cve id", func(t *testing.T) {
    exp := "CVE-2022-44006"
    got := v.Cve.Id.String()
    if got != exp {
      t.Fatalf("got %s, exp %s", got, exp)
    }
  })

  t.Run("source identifier", func(t *testing.T) {
    exp := "cve@mitre.org"
    got := *v.Cve.SourceIdentifier
    if got != exp {
      t.Fatalf("got %s, exp %s", got, exp)
    }
  })

  t.Run("published", func(t *testing.T) {
    exp := *rfc3339.MustParseDateTime("2022-11-16T23:15:12.870")
    got := v.Cve.Published
    if got != exp {
      t.Fatalf("got %v, exp %v", got, exp)
    }
  })

  t.Run("last modified", func(t *testing.T) {
    exp := *rfc3339.MustParseDateTime("2022-11-20T14:02:24.783")
    got := v.Cve.LastModified
    if got != exp {
      t.Fatalf("got %v, exp %v", got, exp)
    }
  })

  t.Run("vulnStatus", func(t *testing.T) {
    exp := "Analyzed"
    got := *v.Cve.VulnStatus
    if got != exp {
      t.Fatalf("got %s, exp %s", got, exp)
    }
  })

  t.Run("descriptions", func(t *testing.T) {
    exp := []LangString {
      LangString {
        Lang: "en",
        Value: "An issue was discovered in BACKCLICK Professional 5.9.63. Due to improper validation or sanitization of upload filenames, an externally reachable, unauthenticated update function permits writing files outside the intended target location. Achieving remote code execution is possible, e.g., by uploading an executable file.",
      },
    }

    got := v.Cve.Descriptions
    if !reflect.DeepEqual(got, exp) {
      t.Fatalf("got %v, exp %v", got, exp)
    }
  })

  // TODO: test cvssv31metrics, rest
}
